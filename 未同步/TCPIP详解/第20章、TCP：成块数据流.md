# 第20章TCP的成块数据流

## 1、引言

```
在第15章我们看到TFTP使用了停止等待协议。数据发送方在发送下一个数据块之前需要等待接收对已发送数据的确认。本章我们将介绍TCP所使用的被称为滑动窗口协议的另一种形式的流量控制方法。该协议允许发送方在停止并等待确认前可以连续发送多个分组。由于发送方不必每发一个分组就停下来等待确认，因此该协议可以加速数据的传输。
```

## 2、正常数据流

![](images20/01-01.jpg)

### 1、快的发送方和慢的接收方

```
当接受方的可用窗口为0时候，发送方将会停止发送，直到接收方再发送一个ack来更新win 窗口。这被称为窗口更新。
```

## 3、滑动窗口

![](images20/01-02.jpg)

```
在这个图中，我们将字节从1至11进行标号。接收方通告的窗口称为提出的窗口(offered window),它覆盖了从第4字节到第9字节的区域，表明接收方已经确认了包括第3字节在内的数据，且通告窗口大小为6.
```

```
当接收方确认数据后，这个滑动窗口不时地向右移动。窗口两个边沿的相对运动增加或减少了窗口的大小。我们使用三个术语来描述窗口左右边沿的运动:
1、称窗口左边沿向右边靠近为窗口合拢。这种现象发生在另一端的接收进程读取已经被确认时。

2、当窗口右边沿向右移动时将允许发送更多的数据，我们称之为窗口张开。这种现象发生在另一端的接收进程读取已经确认的数据并释放了TCP的接收缓存时。

3、当右边沿向左移动时，我们称之为窗口收缩。Host Requirements RFC强烈建议不要使用这种方式。但TCP必须能够在某一端产生这种情况时进行处理。第22.3节给出了这样的一个例子，一端希望向左移动右边沿来收缩窗口，但没能够这样做。

图20-5表示了这三种情况。因为窗口的左边沿受另一端发送的确认序号的控制，因此不可能向左边移动。如果接收到一个指示窗口左边沿向左移动的ACK，则它认为是一个重复ACK，图20-5窗口边沿的移动并被丢弃。
```

![](images20/01-03.jpg)

```
如果左边沿到达右边沿，则称其为一个零窗口，此时发送方不能发送任何数据。

合拢：窗口数据被确认时候会合拢
张开：接收方窗口win变大时候会张开
收缩:win突然变小了？然后就收缩了吧
```

### 一个例子

![](images20/01-04.jpg)

```
以该图为例可以总结如下几点：
1、发送方不必发送一个全窗口大小的数据。
2、来自接受方的一个报文段确认数据并把窗口向右边滑动。这是因为窗口的大小是相对于确认序号的。
3、正如从报文段7到报文段8中变化的那样，窗口的大小可以减小，但是窗口的有边沿却不能够向左移动。
4、接收方在发送一个ACK前不必等待窗口被填满。在前面我们看到许多实现每收到两个报文段就会发送一个ACK。
```

## 4、窗口大小

```的
由接收方提供的窗口的大小通常可以由接收进程控制，这将影响TCP的性能。
显示了在改变发送和接收缓存大小（在单向数据流动的应用中，如文件传输，只需改变发送方的发送缓存和接收方的接收缓存大小）的情况下，位于以太网上的两个工作站之间进行文件传输时的一些结果。它表明对以太网而言，默认的4096字节并不是最理想的大小，将两个缓存增加到16384个字节可以增加约40%左右的吞吐量。
```

## 5、PUSH标志

```
在每一个TCP例子中，我们都看到了PUSH标志，但一直没有介绍它的用途。发送方使用该标志通知接收方将所收到的数据全部提交给接收进程。这里的数据包括与PUSH一起传送的数据以及接收方TCP已经为接收进程收到的其他数据。

在最初的TCP规范中，一般假定编程接口允许发送进程告诉它的TCP何时设置PUSH标志。例如，在一个交互程序中，当客户发送一个命令给服务器时，它设置PUSH标志并停下来等待服务器的响应。通过允许客户应用程序通知其TCP设置PUSH标志，客户进程通知TCP在向服务器发送一个报文段时不要因等待额外数据而使已提交数据在缓存中滞留。类似地，当服务器的TCP接收到一个设置了PUSH标志的报文段时，它需要立即将这些数据递交给服务器进程而不能等待判断是否还会有额外的数据到达。
```





























