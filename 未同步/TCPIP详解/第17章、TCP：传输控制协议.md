# 第17章TCP：传输控制协议

## 1、TCP的服务

```
尽管TCP和UDP都使用相同的网络层(IP),TCP却向应用层提供与UDP完全不同的服务。TCP提供一种面向连接的、可靠的字节流服务。
```

```
面向连接意味着两个使用TCP的应用(通常是一个客户和一个服务器)在彼此交换数据之前必须先建立一个TCP连接。这一过程与打电话很相似，先拨号振铃，等待对方摘机说"喂"，然后才说明是谁。
```

```
在一个TCP连接中，仅有两方进行彼此通信。广播和多播不能用了TCP(可以由服务器与多个客户端创建TCP链接。)
```

```
TCP通过下列方式来提供可靠性:
	
	应用数据被分割成TCP认为最合适发送的数据块。这和UDP完全不同，应用程序产生的数据报长度将保持不变。由TCP传递给IP的信息单位称为报文段或段(segment).
	
	当TCP发出一个段后，它启动一个定时器，等待目的端确认收到这个报文段。如果不能及时收到一个确认，将重发这个报文段。
	
	当TCP收到发自TCP连接另一端的数据，它将发送一个确认。这个确认不是立即发送，通常将推迟几分之一秒
	
	TCP将保持它首部和数据的检验和。这是一个端到端的检验和，目的是检测数据在传输过程中的任何变化。如果收到端的检验和有差错，TCP将丢弃这个报文段和不确认收到此报文段(希望发端超时并重发)。
	
	既然TCP报文段作为IP数据报来传输，而IP数据报的到达可能会失序，因此TCP报文段的到达也可能会失序。如果必要，TCP将对收到的数据进行重新排序，将收到的数据以正确的顺序交给应用层。
	
	既然IP数据报会发送重复(是由于TCP的超时重发机制而导致的)，TCP的接收端必须丢弃重复的数据。
	
	TCP 还能提供流量控制。TCP连接的每一方都有固定大小的缓冲空间。TCP的接收端只允许另一端发送接收端缓冲区所能接纳的数据。这将防止较快主机致使较慢主机的缓冲区溢出。
```

```
两个应用程序通过TCP连接交换8bit字节构成的字节流。TCP不在字节流中插入记录标识符。我们将这称为字节流服务(byte stream service).如果一方的应用程序先传10字节，又传20字节，再传50字节，连接的另一方将无法了解发方每次发送了多少字节。收方可以分4次接收这80字节，每次接受20字节。一端将字节流放到TCP连接上，同样的字节流将出现在TCP连接的另一端

另外，TCP对字节流的内容不作任何解释。TCP不知道传输的数据字节流是二进制数据，还是ASCII字符、EBCDIC字符或者其他类型数据。对字节流的解释由TCP连接双方的应用层解释。
```

```
这种对字节流的处理方式与Unix操作系统对文件的处理方式很相似。Unix的内核对一个应用读或写的内容不作任何解释，而是交给应用程序处理。对Unix的内核来说，它无法区分一个二进制文件与一个文本文件。
```

## 2、TCP的首部

TCP数据被封装在一个IP数据包中。

![](images17/01-01.jpg)

显示TCP首部的数据格式。如果不计任选字段。它通常是20字节

![](images17/01-02.jpg)



```
每个TCP段都包含源端和目的端的端口号，用与寻找发端和收端应用进程。这两个值加上IP首部中的源端IP地址和目的端IP地址唯一确定一个TCP连接。
	有时，一个IP地址和一个端口号也称为一个插口(socket)。插口对(socketpair)(包含客户IP地址、客户端口号、服务器IP地址和服务器端口号的四元组)可唯一确定互联网络中每个TCP连接的双方。
	
	序号用来标识从TCP发端向TCP收端发送的数据字节流，它表示在这个报文段中的第一个数据字节。如果将字节流看作两个应用程序间的单向流动，则TCP用序号对每个字节进行计数。序号是32bit的无符号数，需要到达2^32 -1 后又从0开始。
	
	当建立一个新的连接时，SYN 标志变1,。序号字段包含这个主机选择的该连接的初始序号ISN(initial Sequence Number).该主机要发送数据的第一个字节序号为这个ISN加1，因为SYN标志消耗了一个序号。(是因为这个SYN 是客户端的确认已经连接上了返回回来的序号，如果再发送过去就要将序号+1嘛(因为要把返回回来的连接的序号+1 返会回来的序号是希望服务器再次发送的序号))。
	
	既然每个传输的字节都被计数，确认序号包含发送确认的一端所期望收到的下一个序号。因此，确认序号应当是上次已成功收到数据字节序号加1.只有ACK标志为1时确认序号字段才有效。
	
	发送ACK无需任何代价，因为32bit的确认序号字段和ACK标志一样，总是TCP首部的一部分。因此，我们看到一旦一个连接建立起来，这个字段总是被设置，ACK表示也总是被设置。
	
	TCP为应用层提供全双工服务。这意味数据能在两个方向上独立的进行传输。因此，连接的每一端必须保持每个方向上的传输数据序号。
	
	TCP可以表述为一个没有选择确认或否认的滑动窗口协议，我们说TCP缺少选择确认是因为TCP首部的确认序号表示发方已成功收到字节，但还不包含确认序号所指的字节(协议)。(就是确认了确认序号-1所指的字节(协议)但是确认字节本身的协议并没有确认发送)。当前还无法对数据流中选定的部分进行确认。
	例如，如果1～1024字节已经成功收到，下一报文段中包含序号从2049～3072的字节，收端并不能确认这个新的报文段。它所能做的就是发回一个确认序号为1025的ACK。它也无法对一个报文段进行否认。例如，如果收到包含1025～2048字节的报文段，但它的检验和错，TCP接收端所能做的就是发回一个确认序号为1025的ACK。在21.7节我们将看到重复的确认如何帮助确定分组已经丢失。
```































