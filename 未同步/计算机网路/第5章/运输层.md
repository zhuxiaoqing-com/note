**运输层**

```
本章先概括运输层协议的特点，以及进程之间通信以及端口等重要概念。
然后讲述比较简单的UDP协议。
其余的篇幅都是讨论比较复杂但非常重要的TCP协议 和 可靠传输的原理，包括停止等待协议和ARQ协议。
在详细讲述TCP报文段的首部格式之后，讨论TCP的三个重要问题：
滑动窗口、流量控制和拥塞控制机制。
最后，介绍TCP的连接管理。

运输层是整个网络体系结构中的关键层次之一。
一定要弄清以下一些重要概念：
1、运输层为互相通信的应用进程提供逻辑通信。
2、端口和套接字的意义。
3、无连接的UDP的特点。
4、面向连接的TCP的特点。
5、在不可靠的网络上实现可靠传输到的工作原理，停止等待协议和ARQ协议。
6、TCP的滑动窗口、流量控制、拥塞控制和连接管理。
```

## 1、运输层协议概述

### 1、进程之间的通信

```
从通信和信息处理的角度看，运输层向它上面的应用层提供通信服务，它属于面向通信部分的最高层，同时也是用户功能中的最底层。

当网络的边缘部分中的两个主机使用网络的核心部分的功能进行端到端的通信时，
只有主机的协议栈才有运输层，
而网络核心部分中的路由器在转发分组时都只用到下三层的功能。
```

![](images01-01/01-01.jpg)

![](images01-01/01-02.jpg)

```
下面通过图5-1的示意图来说明运输层的作用。
设局域网LAN1上的主机A和局域网LAN2上的主机B通过互连的广域网WAN进行通信。
我们知道，IP协议能够把源主机A发送出的分组按照首部中的目的地址送交到目的主机B，那么，为什么还需要运输层呢。

从IP层来说，通信的两端是两个主机。
IP数据报的首部明确的标志了这两个主机IP地址。
但"两个主机之间的通信"这种说法还不够清楚。

这是因为，真正通信的实体是在主机中的进程，是这个主机中的一个进程和另一个主机中的一个进程在交换数据(即通信)。
因此严格的讲，两个主机进行通信就是两个主机中的应用进程互相通信。
IP协议虽然能把分组送到目的主机，但是这个分组还停留在主机的网络层而没有交付主机中的应用进程。

从运输层的角度看，通信的真正端点并不是主机而是主机中的进程。
也就是说，端到端的通信是应用进程之间的通信。
在一个主机中经常有多个应用进程同时分别和另一个主机中的多个应用进程通信。

例如，某用户在使用了浏览器查找某网页的信息时，其主机的应用层运行浏览器客户端进程。
如果在浏览网页时的同时，还要用电子邮件给网站发送反馈意见，那么主机的应用层就还要运行电子邮件的客户进程。

在图5-1中，主机A的应用进程AP1和主机B的应用进程AP3通信，而与此同时，应用进程AP2也和对方应用进程AP4通信。

这表明运输层有一个很重要的功能 ---复用(multiplexing) 和 分用(demultiplexing)。

这里的"复用"是指在发送方不同的应用进程都可以使用同一个运输层协议传送数据(当然需要加上适当的首部)，

而"分用"是指接收方的运输层在剥去报文的首部后能够把这些数据正确交付目的应用程序。
图5-1中两个运输层之间有一个双向粗箭头，写明"运输层提供应用进程间的逻辑通信"。
"逻辑通信"的意思是：从应用层来看，只要把应用层报文交给下面的运输层，运输层就可以把这报文传送到对方的运输层(哪怕双方相距很远，例如几千公里)，
好像这种通信就是沿水平方向直接传送数据。
但事实上这两个运输层之间并没有一条水平方向的物理连接。
数据的传送时沿着图中的虚线方向(经过多个层次)传送的。
"逻辑通信"的意思是"好像是这样通信，但事实上并非真的这样通信"。
```

```
从这里可以看出网络层和运输层有明显的区别。
网络层是为主机之间提供逻辑通信，而运输层为应用进程之间提供端到端的逻辑 通信(见图5-2)。
然后正如后面还要讨论的，运输层还具有网络层无法代替的许多其他重要功能。
```

```
运输层还要对收到的报文进行差错检测。
大家应当还记得，在网络层，IP数据报首部中的检验和字段，值检验首部是否出现差错而不检查数据部分。

根据应用程序的不同需求，运输层需要有两种不同的运输协议，即面向连接的TCP和无连接的UDP，这两种协议就是本章要讨论的主要内容。

我们还应当指出，运输层向高层用户屏蔽了下面网络核心的细节(如网络拓扑、所采用的的路由选择协议等)，它使应用进程看见的就是好像在两个运输层实体之间有一条端到端的逻辑通信信道，但这条逻辑通信信道对上层的表现却因运输层使用的不同协议而有很大的差别。

当运输层采用面向连接的TCP协议时，尽管下面的网络是不可靠的(只提供尽最大努力服务)，但这种逻辑通信信道就相当于一条全双工的可靠信道。
但当运输层采用无连接的UDP协议时，这种逻辑通信信道仍然是一条不可靠信道。
```

![](images01-01/01-03.jpg)



### 2、运输层的两个主要协议

```
TCP/IP运输层的两个主要协议都是因特网的正式标准，即
1、用户数据报协议UDP(User datagarm protocol)[RFC 768]
2、传输控制协议TCP(Transmission Control Protocol)[RFC 793]

图5-3给出了这两种协议在协议栈中的位置。
```

![](images01-01/01-04.jpg)

```
按照OSI的术语，两个对等运输实体在通信时传送的数据单位叫作 运输协议数据单元TPDU(Transport Protocol Data Unit)。
但在TCP/IP体系中，则根据所使用的协议是TCP或UDP，分别称之为TCP报文段(segment)或UDP用户数据报。
IP层叫IP数据报
数据链路层叫 帧
物理层叫 比特
```

```
UDP在传送数据之前不需要先建立连接。
远地主机的运输层在收到UDP报文后，不需要给出任何确认。
虽然UDP不提供可靠交付，但在某些情况下UDP缺是一种最有效的工作方式。


TCP则提供面向连接的服务。
在传送数据之前必须先建立连接，数据传送结束后要释放连接。
TCP不提供广播或多播服务。
由于TCP要提供可靠的、面向连接的运输服务，因此不可避免的增加了许多的开销，如确认、流量控制、计时器以及连接管理等。
这不仅使协议数据单元的首部增大很多，还要占用许多的处理机资源。
```

```
表5-1给出了一些应用和应用层协议主要使用的运输层协议(UDP或TCP)。
```

![](images01-01/01-05.jpg)



### 3、运输层的端口

```
前面已经提到过运输层的复用和分用功能。
应用层所有的应用进程都可以通过运输层再传到IP层(网络层)，这就是复用。

运输层从IP层收到数据后必须交付指明的应用程序。这就是分用。

显然，给应用层的每个应用进程赋予一个非常明确的标志是至关重要的。
```

```
我们知道，在单个计算机中的进程是用进程标识符(一个不大的整数)来标志的。
但是因特网环境下，计算机操作系统所指派的这种进程标识符用来标志运行在应用层的各种应用进程则是不行的。

这是因为在因特网上使用的计算机的操作系统种类很多，而不同的操作系统又使用不同格式的进程标识符。
为了使运行不同操作系统的计算机的应用进程能够互相通信，就必须用统一的方法(而这种方法必须与特定操作系统无关)对TCP/IP体系的应用进程进行标志。
```

```
但是，把一个特定机器上运行的特定进程，指明为因特网上通信的最后的终点还是不可行的。
这是因为进程的创建和撤销都是动态的，通信的一方几乎无法识别对方机器上的进程。

另外，我们往往需要利用目的主机提供的功能来识别终点，而不需要知道具体实现这个功能的进程是哪一个(例如，)
```











