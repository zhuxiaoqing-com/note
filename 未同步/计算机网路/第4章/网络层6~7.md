## 6、IP多播

### 1、IP多播的基本概念

```
1988年 steve Deering 首次在其博士学位论文中提出IP多播的概念。
1992年3月IETF在因特网范围首次试验IETF会议声音的多播，当时有20个网点可同时听到会议的声音。
IP多播是需要在因特网上增加更多的智能才能提供的一种服务。

现在IP多播(multicast, 以前曾译为组播)已成为因特网的一个热门课题。
这是由于有许多的应用需要由一个源点发送到许多个终点，即一对多的通信。

例如，实时信息的交付(如新闻、股市行情等)，软件更新，交互式会议等。
随着因特网的用户数目的急剧增加，以及多媒体通信的开展，有更多的业务需要多播来支持。
关于IP多播可参考[W-MCAST]。
```



![](images03-01/01-01.jpg)

```
与单播相比，在一对多的通信中，多播可大大节约网络资源。
图4-46(a)是视频服务器用单播方式向90个主机传送同样的视频节目。
为此，需要发送90个单播，即同一个视频分组要发送90个副本。

图4-46(b)是视频服务器用多播方式向属于同一个多播组的90个成员传送节目。
这时，视频服务器只需要把视频分组当作多播数据报来发送，并且只需发送一次。

路由器R1在转发分组时，需要把收到的分组复制成3个副本，分别向R2、R3和R4各转发1个副本。
当分组到达目的局域网时，由于局域网具有硬件多播功能，因此不需要复制分组，在局域网上的多播组成员都能收到这个视频分组。
```

```
当多播组的主机数很大时(如成千上万个)，采用多播方式就可明显的减轻网络中各种资源的消耗。
在因特网范围的多播要靠路由器来实现，这些路由器必须增加一些能够识别多播数据报的软件。
能够运行多播协议的路由器称为 多播路由器(multicast router)。
多播路由器当然也可以转发普通的单播IP数据报。
```

```
为了适应交互式音频和视频信息的多播，从1992年起，在因特网上开始试验虚拟的多播主干网MBONE(Multicast Backbone On the InterNEt)。
MBONE可把分组传播给地点分散但属于一个组的许多主机。
现在多播主干网已经有了相当大的规模。
```

```
在因特网上进行多播就叫做 IP 多播。
IP多播所传送的分组需要使用多播IP地址。
我们知道，在因特网中每一个主机必须有一个全球唯一的IP地址。
如果某个主机现在想接收某个特定多播组的分组，那么怎样才能使这个多播数据报传送到这个主机？
```

```
显然，这个多播数据报的目的地址一定不能写入这个主机的IP地址。
这是因为在同一时间可能有成千上万个主机加入到同一个多播组。
多播数据报不可能在其首部写入这样多的主机的IP地址。
在多播数据报的目的地址写入的是多播组的标识符，然后设法让加入到这个多播组的主机的IP地址与多播组的标识符关联起来。
```

```
其实多播组的标识符就是IP地址中的D类地址。
D类IP地址的前四位是1110，因此D类地址范围是224.0.0.0到239.255.255.255(见本章第4.2.2 节第1小节"IP地址及其表示方法")。
我们就用每一个D类地址标志一个多播组。
这样，D类地址共可标志 2^28个多播组，也就是说，在同一时间可以允许有超过2.6亿的多播组在因特网上运行。
多播数据报也是"尽最大努力交付"，不保证一定能够交付多播组内的所有成员。
因此，多播数据报和一般的IP数据报的区别就是它使用D类IP地址作为目的地址，并且首部中的协议字段值是2，表明使用网际组管理协议IGMP。
```

```
显然，多播地址只能用于目的地址，而不能用于源地址。
此外，对多播数据报不产生ICMP差错报文。
因此，若在PING命令后面键入多播地址，将永远不会收到响应。

D类地址中有一些是不能随意使用的，因为有的地址已经被IANA指派为永久组地址了[RFC 5735]。
例如
```

![](images03-01/01-02.jpg)



```
IP 多播可以分为两种。
一种是只在本局域网上进行硬件多播，另一种则是在因特网的范围进行多播。
前一种虽然比较简单，但很重要，因为现在大部分主机都是通过局域网接入到因特网的。
在因特网上进行多播的最后阶段，还是要把多播数据报在局域网上用硬件多播交付多播组的所有成员(如图4-46(b)所示)。
下面就先讨论这种硬件多播。
```



### 2、在局域网上进行硬件多播

```
因特网号码指派管理局IANA 拥有的以太网地址块的高24位为00-00-5E,因此TCP/IP协议使用的以太网多播地址块的范围是从00-00-5E-00-00-00 到 00-00-5E-FF-FF-FF。
在第三章3.4.3节已讲过，以太网硬件地址字段中的第1字节的最低位为1时为多播地址，这种多播地址数占IANA分配到的地址数的一半。
因此IANA拥有的以太网多播地址的范围是从01-00-5E-00-00-00 到 01-00-5E-7F-FF-FF 
为什么mac地址少了一半。。。不清楚；应该是本来就只公开了这一半能使用。

不难看出，在每一个地址中，只有23位可用作多播。
这只能和D类IP地址中的23位有意义对应的关系。

D类IP地址可供分配的有28位，可见在这28位中的前5位不能用来构造以太网硬件地址(图4-47)。

例如，IP多播地址224.128.64.32(即E0-80-40-20)和另一个IP多播地址 224.0.64.32(即E0-00-40-20)转换成以太网的硬件多播地址都试 01-00-5E-00-40-20。
由于多播IP地址与以太网硬件地址的映射关系不是唯一的，因此收到多播数据报的主机，还要在IP层利用软件进行过滤，把不是本主机要接收的数据报丢弃。
```

![](images03-01/01-03.jpg)

下面就讨论进行IP多播所需要的协议



### 3、网际组管理协议IGMP和多播路由选择协议

#### 1、IP多播需要两种协议

![](images03-01/01-04.jpg)

```
图4-48是在因特网上传送多播数据报的例子。
图中标有IP地址的四个主机都参加了一个多播组，其组地址是226.15.37.123。
显然，多播数据报应当传送到路由器 R1,R2,R3,
而不应当传送到路由器R4，因为与R4连接的局域网上现在没有这个多播组的成员。
```

IGMP

```
图4-48强调了 IGMP 的本地使用范围。
请注意，IGMP并非在因特网范围内对所有多播组成员进行管理的协议。
IGMP不知道IP多播组包含的成员数，也不知道这些成员都分布在哪些网络上，等等。
IGMP协议是让连接在本地局域网上的多播路由器知道本局域网上是否有主机(严格讲，是主机上的某个进程)参加或退出了某个多播组。

IGMP是组播路由器用来维护组播组成员信息的协议，运行于主机和和组播路由器之间。
```

多播路由器

```
显然，仅有IGMP协议是不能完成多播任务的。
连接在局域网上的多播路由器还必须和因特网上的其他多播路由器协同工作，以便把多播数据报用最小代价传送给所有的组成员。
这就需要使用多播路由选择协议。
```

```
然后多播路由器选择协议要比单播路由选择协议复杂的多。
我们可以通过一个简单的例子来说明(图4-49)
```

![](images03-01/01-05.jpg)



```
我们假定图4-49中有两个多播组。
多播组1的成员有主机 A,B,C,
而多播组2的成员有主机 D,E,F。
这些主机分布在三个网络上(N1,N2,N3)。

路由器R不应当向网络N3转发多播组1的分组，因为网络N3上没有多播组1的成员。
但是每一个主机可以随时加入或离开一个多播组。

例如，主机G现在加入了多播组1。
从这时起，路由器R就必须也向网络N3转发多播组1的分组。
这就是说，多播转发必须动态的适应多播组成员的变化(这时网络拓扑并未发生变化)。
请注意，单播路由器选择通常是在网络拓扑发生变化时才需要更新路由。
```

```
再看一种情况。
主机E和F都是多播组2的成员。
当E向F发送多播数据报时，路由器R把这个多播数据报转发到网络N3。
但当F向E发送多播数据报时，路由器R则把多播数据报转发到网络N2。
如果路由器R收到来自主机A的多播数据报(A不是多播组2的成员，但是也可以向多播组发送多播数据报)，那么路由器R就应当把多播数据报转发到N2和N3。

由此可见，多播路由器在转发多播数据报时，不能仅仅根据多播数据报中的目的地址，而是还要考虑这个多播数据报从什么地方来和要到什么地方去。

向E发送的组播，要考虑到起点是N2，所以不再转发到N2网络上，而是直接往N3网路转发
```

```
还有一种情况，主机G没有参加任何多播组，但G却可向任何多播组发送多播数据报。

例如，G可向多播组1或2发送多播数据报。
主机G所在的局域网上可以没有任何多播组的成员。

显然，多播数据报所经过的许多网络，也不一定非要有多播组成员。
总之，多播数据报可以由没有加入多播组的主机发出，也可以通过没有组成员接入的网络。

正因为如此，IP多播就成为比较复杂的问题。下面介绍这两种协议的要点。
```



#### 2、网际组管理协议IGMP

```
IGMP已有了三个版本。
1989年公布的RFC1112(IGMPv1)早已成为了因特网的标准协议。
1997年公布的RFC2236(IGMPv2，建议标准)对IGMPv1进行了更新。
2002年10月公布了RFC3376(IGMPv3，建议标准)，宣布RFC2236(IGMPv2)是陈旧的。
```

```
和网际控制报文协议ICMP相似，IGMP使用IP数据报传递其报文(即IGMP报文加上IP首部构成IP数据报)，但它也向IP提供服务。
因此，我们不把IGMP看成是一个单独的协议，而是属于整个网际协议IP的一个组成部分。
```

```
从概念上将，IGMP的工作可分为两个阶段。

第一阶段：当某个主机加入新的多播组时，该主机应向多播组的多播地址发送一个IGMP报文，声明自己要称为该组的成员。
本地的多播路由器收到IGMP报文后，还要利用多播路由选择协议把这种组成员关系转发给因特网上的其他多播路由器。

第二阶段：
组成员关系是动态的。
本地多播路由器要周期性的探询本地局域网上的主机，以便知道这些主机是否还继续是组的成员。
只要有一个主机对某个组响应，多播路由器就认为这个组时活跃的。
但一个组在经过几次的探询后仍然没有一个主机响应，多播路由器就认为本网络上的主机已经都离开了这个组，因此也就不再把这个组的成员关系转发给其他的多播路由器。
```

```
IGMP设计的很仔细，避免了多播控制信息给网络增加大量的开销。
IGMP采用的一些具体措施如下：
下面所有的通信都只是路由器和主机可用

1、在主机和多播路由器之间的所有的通信都使用IP多播。
只要有可能，携带IGMP报文的数据报都用硬件来多播传送。
因此在硬件多播的网络上，没有参加IP多播的主机都不会收到IGMP报文。

2、多播路由器在探询组成员关系时，只需要对所有的组发送一个请求信息的询问报文，而不需要对每一个组发送一个询问报文(虽然也允许对一个特定组发送询问报文)。
默认的询问速率是每125秒发送一次(通信量并不大)。

3、当同一个网络上连接有几个多播路由器时，它们能够迅速和有效的选择其中的一个来探询主机的成员关系。
因此，网络上有多个多播路由器并不会引起IGMP通信量的增大。

4、在IGMP的询问报文中有一个数值N，它指明一个最长响应时间(默认值为10秒)。
当收到询问时，主机在0和N之间随机选择发送响应所需经过的时延。
因此，若一个主机同时参加了几个多播组，则主机对每一个多播组选择不同的随机数。
对应于最小时延的响应最先发送。

5、同一个组内的每一个主机都要监听响应，只要有本组的其他主机先发送了响应，自己就可以不再发送响应了。
这样就抑制了不必要的通信量。(因为是局域网内发送，所以监听不需要消耗资源)


多播路由器并不需要保留组成员关系的准确记录,因为向局域网上的组成员转发数据报是使用硬件多播。
多播路由器只需知道网络上是否至少有一个主机是本组成员即可。
实际上，对询问报文每一个组只须有一个主机发送响应。

如果一个主机上有多个进程都加入了某个多播组，那么这个主机对发给这个多播组的每个多播数据报值接收一个副本，然后给主机中的每一个进程发送一个本地复制的副本。

最后我们还要强调指出，多播数据报的发送者和接收这都不知道(也无法找出)一个多播组的成员有多少，以及这些成员是哪些主机。
因特网中的路由器和主机都不知道哪个应用进程将要向哪个多播组发送多播数据报，因为任何应用进程都可以在任何时候向任何一个多播组发送多播数据报，而这个应用进程并不需要加入这个多播组。

IGMP 有两部分
1、新加入组发送消息
2、定时心跳
```



#### 3、多播路由选择协议

```
虽然在TCP/IP多播协议已成为建议标准，但多播路由选择协议(用来在多播路由器之间传播路由信息)则尚未标准化。

在多播过程中一个多播组中的成员是动态变化的。
例如在收听网上某个广播节目时，随机会有主机加入或离开这个多播组。

多播路由选择实际上就是要找出以源主机为根节点的多播转发树。
在多播转发树上，每一个多播路由器向树的叶节点方向转发收到的多播数据报，但在多播转发树上的路由器不会收到重复的多播数据报(即多播数据报不应在互联网中兜圈子)。
不难看出，对不同的多播组对应于不同的多播转发树。
同一个多播组，对不同的源点也会有不同的多播转发树。

至于这个多播转发树怎么来的，就和路由协议一样同步来的呗
```

```
已有了多种实用的多播路由选择协议，它们在转发多播数据报时使用了以下的三种方法：
```

##### 1、洪泛与剪除

```
1、洪泛与剪除
这种方法适用于较小的多播组，而所有的组成员接入的局域网也是相邻接的。
一开始，路由器转发多播数据报使用洪泛的方法(这就是广播)。
为了避免兜圈子，采用了反向路径广播RPB(Reverse Path Broadcasting)的策略。

RPB的要点是：每一个路由器在收到一个多播数据报时，先检查数据报是否从源点经最短路径传送来的。
进行这种检查很容易，只要从本路由器寻找到源点的最短路径上(之所以叫做反向路径，因为计算最短路径时是把源点当做终点)的第一个路由器是否就是刚才把多播数据报送来的路由器。

若是，就向所有其他方向转发刚才收到的多播数据报(但进入的方向除外)，否则就丢弃而不转发。
如果本路由器有好几个相邻路由器都处在到源点的最短路径上(也就是说，存在几条同样长度的最短路径)，那么只能选择一条最短路径，选择的准则就是看这几条最短路径中的相邻路由器谁的IP地址最小。

图4-50的例子说明了这一概念。
```

![](images03-01/01-06.jpg)

```
为了简单起见，在图4-50中的网络用路由器之间的链路来表示。
我们假定各路由器之间的距离都是1。
路由器R1收到源点发来的多播数据报后，向R2和R3转发。
R2发现R1就在自己到源点的最短路径上，因此向R3和R4转发收到的数据报。
R3发现R2不在自己到源点的最短路径上，因此丢弃R2发来的数据报。
其他路由器也这样转发。

R7到源点有两条最短路径：R7->R4->R2->R1->源点；
R7->R5->R3->R1->源点。

我们再假定R4的IP地址比R5的IP地址小，所以我们只使用前一条最短路径。
因此R7只转发R4传过来的数据报，而丢弃R5传过来的数据报。

最后就得出了用来转发多播数据报的多播转发树(图中用粗线表示)，以后就按这个多播转发树来转发多播数据报。
这样就避免了多播数据报兜圈子，同时每一个路由器也不会接收重复的多播数据报。
```

```
如果多播转发树上的某个路由器发现它的下游树枝(即叶节点方向)已没有该多播组的成员，就应把它和下游的树枝一起剪除。
例如，在图4-50中虚线椭圆表示剪除的部分。
当某个树枝有新增加的组成员时，可以再接入到多播转发树上。
```



##### 2、隧道技术(tunneling)

```
隧道技术适用于多播组的位置在地理上很分散的情况。
例如在图4-51中，网1和网2都支持多播。
```

![](images03-01/01-07.jpg)

```
现在网1中的主机向网2中的一些主机进行多播。
但路由器R1和R2之间的网络并不支持多播，因而R1和R2不能按多播地址转发数据报。
为此，路由器R1就对多播数据报进行再次封装，即再加上普通数据报首部，使之成为单一目的站发送的单播(unicast)数据报，然后通过"隧道"(tunnel)从R1发送到R2。
```

```
单播数据报到路由器R2后，再由路由器R2剥去其首部，使它又恢复成原来的多播数据报，继续向多个目的站转发。
这种使用隧道技术传送数据报又叫做IP
```













