第三章 数据链路层



```
数据链路层协议几乎总是把 CRC 放在尾部，而不是放在头部，为什么

答案：
	CRC是在发送期间进行计算的。
	一旦把最后一位数据送上外出线路，就立即把CRC编码附加在输出流的后面发出。
	如果CRC放在帧的头部，那么就要在发送之前把整个帧先检查一遍来计算CRC。
	这样每个字节都要处理两遍，第一遍是为了计算检验码，第二遍是为了发送。
	把CRC放在尾部就可以把处理时间减半。
```





```
数据链路层属于计算机网络的低层。数据链路层使用的信道主要有以下两种类型：

1、点对点信道。这种信道使用一对一的点对点通信方式。

2、广播信道。这种信道使用一对多的广播通信方式，因此过程比较复杂。
广播信道上连接的主机很多，因此必须使用专用的共享信道协议来协调这些主机的数据发送。 
```

```
局域网虽然是个网络，但我们并不把局域网放在网络中讨论。
这是因为在网络层要讨论的问题是分组怎么样从一个网络通过路由器转发到另一个网络，
但在本章中我们研究的是在同一个局域网中，分组怎样从一个主机传送到另一个主机(不经过路由器)。
因此，这是属于数据链路层的范围。
```

```
本章的大致内容是：
	1、数据链路层的点对点信道和广播信道的特点，以及这两种信道所使用的协议(PPP 协议以及 CSMA/CD协议)的特点。
	2、数据链路层的三个基本问题：封装成帧、透明传输和差错检测。
	3、适配器、转发器、集线器、网桥、以太网交换机的作用以及使用场合。
```



## 1、使用点对点信道的数据链路层

### 1、数据链路和帧

```
我们在这里要明确一下，"链路"和"数据链路"并不是一回事。
```

```
所谓链路"link"就是从一个结点到相邻结点的一段物理线路(有线或无线)，而中间没有任何其他的交换结点。
在进行数据通信时，两个计算机之间的通信路径往往要经过许多段这样的链路。
可见链路只是一条路径的组成部分。
```

```
数据链路(data link)则是另一个概念。
这是因为当需要在一条线上传送数据时，除了必须有一条物理线路外，还必须有一些必要的通信协议来控制这些数据的传输。
若把实现这些协议的硬件和软件加到链路上，就构成了数据链路。
现在最常用的方法是使用 网络适配器(既有硬件，也包括软件)来实现这些协议。
一般的适配器都包括了数据链路层和物理层这两层的功能。
```

```
也有人采用另外的术语。
这就是把链路分为物理链路和逻辑链路。
物理链路就是上面所说的链路，而逻辑链路就是上面的数据链路，是物理链路加上必要的通信协议。
```

```
早期的数据通信协议曾叫作通信规程(procedure)。
因此在数据链路层，规程和协议是同义词。
```

```
下面再介绍点对点信道的数据链路层的协议数据单元 --- 帧。
```

```
数据链路层把网络层交下来的数据构成帧发送到链路上，以及把接收到的帧中的数据取出并上交给网络层。
在因特网中，网络层协议数据单元就是IP数据报(或简称为数据报、分组或包)。
```

```
为了把主要精力放在点对点信道的数据链路层协议上，可以采用如图 3-3(a)所示的三层模型。
```

![](images01-01/01-01.jpg)

```
点对点信道的数据链路层在进行通信时的主要步骤如下：
1、结点A的数据链路层把网络层交下来的IP数据报添加首部和尾部封装成帧。
2、结点A把封装好的帧发送给结点B的数据链路层。
3、若结点B的数据链路层收到的帧无差错，则从收到的帧中提取出IP数据报上交给上面的网络层；否则丢弃这个帧。

数据链路层不必考虑物理层如何实现比特传输的细节。
我们甚至还可以更简单的设想好像是沿着两个数据链路层之间的水平方向把帧直接发送给对方，如图3-3(b)所示。
```

### 2、三个基本问题

```
数据链路层协议有许多种，但有三个基本问题则是共同的。
这三个基本问题是：封装成帧、透明传输和差错检测。
下面分别讨论这三个基本问题。
```

#### 1、封装成帧

```
封装成帧(framing)就是在一段数据的前后分别添加首部和尾部，这样就构成了一个帧。
接收端再收到物理层上交的比特流后，就能根据首部和尾部的标记，从收到的比特流中识别帧的开始和结束。

图3-4表示用帧首部和帧尾部封装成帧的一般概念。
我们知道，分组交换的一个重要的概念就是：
所有因特网上传送的数据都是以分组(即IP数据报)为传送单位的。

网络层的ip数据报传送到数据链路层就成为帧的数据部分。
在帧的数据部分的前面和后面分别添加上首部和尾部，构成了一个完整的帧。
这样的帧就是数据链路层的数据传送单元。

一个帧的帧长等于帧的数据部分长度加上帧首部和帧尾部的长度。
首部和尾部的一个重要作用就是进行帧定界(即确定帧的界限)。
此外，首部和尾部还包括许多必要的控制信息。
在发送帧时，是从帧首部开始发送。
各种数据链路层协议都对帧首部和帧尾部的格式有明确的规定。
显然，为了提高帧的传输效率，应当使帧的数据部分长度尽可能的大于首部和尾部的长度。

但是，每一种链路层协议都规定了所能传送的帧的数据部分长度上限 --- 最大传送单元 MTU(Maximum Transfer Unit)。
图3-4给出了帧的首部和尾部的位置，以及帧的数据部分与MTU的关系。
```

![](images01-01/01-02.jpg)

```
当数据是由可打印的 ASCII 码组成的文本文件时，帧定界可以使用特殊的帧定界符。
我们知道，ASCII 码是7位编码，一共可组成128个不同的 ASCII 码，其中可打印的有95个，而不可打印的控制字符有33个。
```

![](images01-01/01-03.jpg)

![](images01-01/01-04.jpg)

```
当数据在传输中出现差错时，帧定界符的作用更加明显。
假定发送端在尚未发送完一个帧时突然出故障，中断了发送。
但随后很快有恢复正常，于是重新从头开始发送刚才未发送完的帧。
由于使用了帧定界符，在接收端就知道前面收到的数据是个不完整的帧(只有首部开始符 SOH 没有传输结束符EOT)，必须丢弃。
而后面收到的数据有明确的帧定界符(SOH和EOT)，因此这是一个完整的帧，应当收下。
```

#### 2、透明传输

```
由于帧的开始和结束的标记是使用专门指明的控制字符，因此，所传输的数据中的任何8比特的组合一定不允许和用作帧定界的控制字符的比特编码一样，否则会出现帧定界的错误。
```

![](images01-01/01-05.jpg)

```
像图 3-6 所示的帧的传输显然就不是"透明传输"，因为当遇到数据中碰巧出现字符"EOT"时就传不过去了。
数据中的"EOT"被接收端当作是无效帧而丢弃。
但实际上在数据中出现的字符"EOT"并非控制字符而仅仅是二进制数据 00000100。
```

```
前面提到的"透明"是一个很重要的术语。
它表示:某一个实际存在的事物看起来缺是好像不存在一样。
在数据链路层透明传送数据，表示无论什么样的比特组合的数据都能够通过这个数据链路层。
因此，对所传送的数据来说，这些数据就"看不见"数据链路层有什么妨碍数据传输的东西。
或者说，数据链路层对这些数据来说是透明的。
```

```
为了解决透明传输问题，就必须设法使数据中可能出现的控制字符 "SOH" 和 "EOT" 在接收端不被解释为控制字符。

具体的方法是：发送端的数据链路层在数据中出现控制字符"SOH"或"EOT"的前面插入一个转义字符"ESC"(其十六进制编码时 1B，二进制是 00011011)。
而在接收端的数据链路层在把数据送往网络层之前删除这个插入的转义字符。

这种方法称为字节填充"byte stuffing" 或字符填充(character stuffing)。
如果转义字符也出现在数据当中，那么解决方法仍然是在转义字符前面插入一个转义字符。
因此，当接收端收到连续的两个转义字符时，就删除其中前面的一个。

图3-7表示用字节填充法 解决透明传输的问题。
```

![](images01-01/01-06.jpg)



#### 3、差错检测

```
现实的通信链路都不会是理想的。
这就是说，比特在传输过程中可能会产生差错：
1可能会变成0，而0也可能变成1.这就叫做比特差错。
比特差错时传输差错中的一种。
本小节所说的 "差错"，如无特殊说明，就是指"比特差错"。
在一段时间内，传输错误的比特占所传输比特总数的比率称为 误码率BER(bit error rate).

例如，误码率为 10^-10 时，表示平均每传送 10^10 个比特就会出现一个比特的差错。
误码率与信噪比有很大的关系。
如果设法提高信噪比，就可以使误码率减小。

实际的通信链路并非是理想的，它不可能使误码率下降到零。
因此，为了保证数据传输的可靠性，在计算机网络传输数据时，必须采用各种差错检测措施。
目前在数据链路层广泛使用了 循环冗余检验 CRC(cyclic Redundancy Check)的检错技术。
```

```
下面我们通过一个简单的例子来说明循环冗余检验的原理.

在发送端,先把数据划分为组,假定每组 k 个比特。
现假定待发送数据 M = 101001(k = 6).
CRC 运算就是在数据 M 的后面添加供差错检验用的 n 位冗余码，然后构成一个帧发送出去，一共发送(k+n)位。
在所要发送的数据后面增加 n 位冗余码，虽然增大了数据传输的开销，
但却可以进行差错检验。
当传输可能出现差错时，付出这种代价往往是很值得的。
```



```
注：用模2运算进行加法时不进位，
例如 1111+1010=0101。
减法和加法一样，按加法规则计算。
```

```
这 n 位冗余码可用以下方法得出。
用二进制的模2运算进行2^n乘 M 的运算，这相当于在 M 后面添加 n 个 0。
得到的 (k+n)位的数除以收发事先商定的长度为(n+1)位的除数 P,得出商是 Q 而余数是 R(n位，比P少一位)。
关于除数P下面还要介绍。
在图3-8所示的例子中，M = 101001(即k=6)。
假定除数P=1101(即n=3)。
经模2除法运算后的结果是 ：商Q = 110101(这个商并没有什么用处)，而余数R = 001。
这个余数R就作为冗余码拼接在数据M的后面发送出去。
这种为了进行检错而添加的冗余码常称为帧检验序列FCS(Frame Check Sequence).
因此加上FCS后发送的帧时 101001001 即 (2^n)M+FCS，共有(k+n)位。
```

![](images01-01/01-07.jpg)

```
顺便说一下，循环冗余检验CRC 和 帧检验序列FCS并不是同一个概念。
CEC是一种检错方法，
而FCS是添加在数据后面的冗余码，
在检验方法上可以选用CRC，但也可不选用CRC。
```

[CRC在发送中校验](https://www.cnblogs.com/94cool/p/3559585.html)

```
在接收端把接收到的数据以帧为单位进行CRC校验：把收到的每一个帧都除以同样的除数P(模2运算)，然后检查得到的余数R。
```

```
如果在传输过程中无差错，那么经过CRC校验后得出的余数R肯定是0。
```

```
但如果出现误码，那么余数R仍等于零的概率是非常非常小的(详情请看书)。
```

```
总之，在接收端对收到的每一帧经过CRC校验后，有以下两种情况
1、若得出的余数R=0，则判定这个帧没有差错，就接受accept.
2、若余数R!=0,则判定这个帧有差错(但无法确定究竟是哪一位或哪几位出现了差错)，就丢弃。
```

```
一种较方便的方法是用多项式来表示循环冗余检验过程。
在上面的例子中，用多项式 P(X)=X^3+X^2+1 表示上面的除数 P =1101 (最高位对应于 X^3, 最低位对应于 X^0)。 
多项式P(X)称为生成多项式。
现在广泛使用的生成多项式P(X)有以下几种：

X^0 就是 1;
```

![](images01-01/01-08.jpg)

```
在数据链路层，发送端帧检验序列 FCS 的生成和接收端的 CRC 检验都是用硬件完成的，处理很迅速，因此并不会延误数据的传输。
```



```
以上的讨论不难看出，如果我们在传送数据时不以帧为单位来传送，那么就无法加入冗余码以进行差错检验。
因此，如果要在数据链路层进行差错检验，就必须把数据划分为帧，每一帧都加上冗余码，一帧接一帧的传送，然后在接收方逐帧进行差错检验。
```

```
最后再强调一下，在数据链路层若仅仅使用循环冗余检验CRC差错检验技术，则只能做到对帧的无差错接受，即:"凡是接收端数据链路层接受的帧，我们都能以非常接近于1的概率认为这些帧在传输过程中没有产生差错"。
接收端丢弃的帧虽然曾收到了，但最终还是因为有差错被丢弃，即没有被接受。
以上所述的可以近似地表述为(通常都是这样认为)："凡是接收端数据链路层接受的帧均无差错"。
```

```
请注意，我们现在并没有要求数据链路层想网络层提供"可靠传输"的服务。
所谓"可靠传输"就是：数据链路层的发送端发送什么，在接收端就收到什么。
传输差错可分为两大类：
	一类就是前面所说的最基本的比特差错，
	而另一类传输差错则更复杂些，这就是收到的帧并没有出现比特差错，
	但却出现了帧丢失、帧重复或帧失序。
```

![](images01-01/01-09.jpg)

```
以上三种情况都属于"出现传输差错"，但都不是这些帧里有"比特差错"。
帧丢失很容易理解。
但出现帧重复和帧失序的情况则较为复杂，对这些问题我们现在不展开讨论。
我们在后面章节会讨论。
```

```
总之，我们应当明确，"无比特差错"与"无传输差错"并不是同样的概念。
在数据链路层使用CRC检验，能够实现无比特差错的传输，但这还不是可靠传输。
```

```
我们知道，过去OSI的观点是：必须让数据链路层向上提供可靠传输。
因此在CRC检错的基础上，增加了帧编码、确认和重传机制。
收到正确的帧就要向发送端发送确认。
发送端在一定的期限内若没有收到对方的确认，就认为出现了差错，因而就进行重传，知道收到对方的确认为止。
这种方法在历史上曾经起到了很好的作用。
但现在的通信线路的质量已经大大提高了，由通信链路质量不好引起差错的概率已经大大降低。
因此，现在因特网就采取了区别对待的方法：
```

```
对于通信质量良好的有限传输链路，数据链路层不使用确认和重传机制，即不要求数据链路层向上提供可靠传输的服务。
如果在数据链路层传输数据时出现了差错并且需要进行改正，那么改正差错的任务就由上层协议(例如，运输层的TCP协议)来完成。
```

```
对于通信质量较差的无线传输链路，数据链路层协议使用确认和重传机制，数据链路层向上提供可靠传输的服务。(见第九章 无线网络)
```

```
实践证明，这样做可以提高通信效率。
```

## 2、网络上的PPP协议讲解

[网络上的PPP协议讲解](https://www.cnblogs.com/5iedu/p/6940007.html)

### 1、点到点通信

```
1、点到点信道是指一条链路上就一个发送端和接收端的信道，通常用在广域网链路。
如两个路由器通过串口相连或家庭用户使用调制调节器通过电话线拨号连接ISP。
```

![](images01-01/01-10.jpg)



```
2、早期通信线路质量差，在数据链路层使用可靠传输协议(HDLC,高级数据链路控制协议)。
现在最广泛使用的是较为简单的PPP点到点协议。
```

### 2、PPP协议的特点

```
1、简单：PPP协议不负责可靠传输、纠错和流量控制，也不需要给帧编号，接收端收到帧后就进行CRC检验。
如果正确就收下，反之直接丢弃，其他什么也不做。

2、封装成帧：每种数据链路层协议都是特定的帧定界符，用于接收端从收到的比特流中准确的找到帧开始和结束的位置。

3、透明传输：保证数据传输的透明性。比如数据中碰巧出现了和帧定界符一样的比特组合时，要采取有效措施来解决。

4、通过检测技术将传输中出现差错的帧丢弃，以防止出错的帧被继续转发而白白浪费了网络资源。

5、支持多种网络层协议：同一条物理链路上同时支持多种网络协议(如 IP和 IPV6)。这意味着IP数据报和IPV6数据都可以封装在PPP帧中进行传输。

6、多种类型链路：能够在多种类型的链路上运行(如串行或并行、同步或异步、低速或高速、电或光等)。

7、检测连接状态：具有一种机制能够及时自动检测出链路是否处于正常工作状态。
当出现故障的链路隔一段时间后又重新恢复正常是，就特别需要这种检测功能

8、最大传送单元：当高层协议发送的分组过长并超过MTU数据值，PPP就要丢弃这样的帧，并返回差错。(注意：MTU指的是帧的数据部分的最大长度，而不是帧的总长度)。

9、网络层地址协商：PPP协议提供一种机制使通信的两个网络层实体能够通过协商知道或配置彼此的网络层地址(ADSL拨号上网，ISP给的是一个公网地址)，这就是PPP协议的功能。

10、数据压缩协商：提供一种协商使用数据压缩算法，但PPP协议并不要求将数据压缩算法进行标准化。
```

### 3、PPP协议的组成

![](images01-01/01-11.jpg)

```
1、高级数据链路层控制协议：将IP数据报封装到串行链路的方法。既支持异步链路也支持同步链路。

2、链路控制协议：用来建立、配置和测试数据链路的连接，通信的双方可协商一些选项。

3、网络控制协议：支持不同的网络协议，如IP、IPv6、DECent 以及 AppleTalk 等。
```

### 4、串行通信的同步传输和异步传输

#### 1、同步传输

![](images01-01/01-12.jpg)

```
1、同步传输以数据帧为单位传输数据(注意每个数据帧的大小是不固定的！)。

2、在短距离的高速传输中，时钟信号可由专门的时钟线路传输。双方按相同的时钟信号进行收发。

3、计算机网络采取的同步方式，常将时钟信号(前同步码)植入数据信号帧中，以时间接收端与发送端的时钟同步。
也有用专门的一个 带宽段专门进行时间 频率同步的。
```

#### 2、异步传输

![](images01-01/01-13.jpg)

```
1、异步传输以字符为单位传输数据(注意：传输单位是固定的，如8比特为一个单位)。
2、异步传输通过字符开始的开始码和停止码抓住再同步的机会，而同步传输则是从前同步码中抽取同步信息。
3、异步传输每个字符中要多传递2比特信息，总传输负载量增加不小。
其传输效率比同步传输效率低。
```

#### 3、同步传输和异步传输的区别

```
1、异步传输是面向字符的传输，传输单位为字符。
而同步传输是面向比特的传输，传输单位是帧。
2、异步传输通过字符的开始码和停止码抓住再同步的机会，而同步传输则是从前同步码中抽取同步信息。
3、异步传输每个字符中要多传递2比特信息，总传输负载量增加不小。
其传输效率比同步传输效率低。
异步传输对于那些数据传输量的高速设备来说，增加了不少传输量。
因此，适合用于数据传输量较小的低俗设备。

同步传输的同步时钟有前同步码 网同步等方式

异步传输的同步方式是(群同步)根据起始位和停止位 然后根据事先规定的传输速率和协议格式来矫正时钟，因为每一个字符都会矫正一次时钟，所以时钟的准确性不需要像同步传输一样严格。
但是由于每一个字符都带了起始位和停止位 数据量就比同步传输要大多了。
```



### 5、PPP协议帧的格式

![](images01-01/01-14.jpg)

```
1、帧开始和结束定界符均为 0x7E
2、A字段为地址字段(值为0xFF),该字段没有源地址和目标地址，形同虚设。
C字段为控制字段(值为0x03，具体的定义至今没给出)。
3、FCS为2个字节的帧校验序列
4、信息部分的长度不超过15000字节。PPP是面向字节的，所有PPP帧的长度都是整数字节的倍数。
```

```
PPP首部的第四个字段是2字节的协议字段。
当协议字段为 0x0021时，PPP帧的信息字段就是IP数据报
当协议字段为 0xC021时，PPP帧的信息字段就是LCP数据报
当协议字段为 0x8021时，PPP帧的信息字段就是网络层的控制数据
```



#### 1、异步传输使用字节填充

![](images01-01/01-15.jpg)

```
1、在异步传输的链路上，数据传输是以自己为单位，PPP帧的转义字符定为0x7D,并使用字节填充。
2、把信息字段(即开始和结束定界符外)中出现的每一个0X7E字节转变为2字节的(0x7D,0x5E)。
3、若信息字段出现一个0x7D的字节(即出现了和转入字符一样的比特组合)，则把0x7D转变为2字节序列(0x7D,0x5D)
```

#### 2、同步传输使用零比特填充

![](images01-01/01-16.jpg)

```
1、在同步传输的链路上，数据传输以帧为单位，PPP协议采用零比特填充的方法来实现透明传输。(注意PPP协议帧定界符为0x7E,二进制位 0111 1110)
2、发送端先扫描整个信息字段(通常由硬件实现)，只要发现有连接的5个1，则立即填入一个0.
从而保证在信息字段中不会出现帧定界符(6个连续的1)
3、接收端收到数据后，从确定一个帧的开始，接着扫描比特流，如果发现连续的5个1，就把其后的0删除，还原成原来的信息比特流。
```



### 3、PPP协议的工作状态

```
上一节我们通过 ppp帧的格式讨论了 PPP 帧时怎样组成的。
但PPP链路一开始是怎样被初始化的？
当用户拨号接入ISP后，就建立了一条从用户PC到ISP的物理连接。
这时，用户PC向ISP发送一系列的链路控制协议LCP分组(封装成多个PPP帧)，以便建立LCP连接。
这些分组及其相应选择了将要使用的一些 PPP 参数。
接着还要进行网络层配置，网络控制协议NCP给新接入的用户PC分配了一格临时的IP地址。
这样，用户PC就称为因特网上的一个有IP地址的主机了。
```

```
当用户通信完毕时，NCP释放网络层连接，收回原来分配出去的IP地址。
接着LCP释放数据链路层连接。
最后释放的是物理层的连接。
```

```
上述过程可用图3-12的状态来描述。
```

![](images01-01/01-17.jpg)

```
PPP链路的起始和终止状态永远是图3-12中的"链路静止"(link Dead)状态，这时在用户PC和ISP的路由器之间并不存在物理层的连接。

当用户PC通过调制器呼叫路由器时(通常是在屏幕上用鼠标点击一个连接按钮)，路由器就能够检测到调制解调器发出的载波信号。
在双方建立了物理层连接后，PPP就进入了"链路建立"(link Establish)状态，其目的是建立链路层的LCP连接。
```

```
这时LCP开始协商一些配置选项，即发送LCP的配置请求帧(Configure-Request)。
这是个PPP帧，其协议字段置为LCP对应的代码，而信息字段包含特定的配置请求。
链路的另一端可以发送以下几种响应中的一种：

1、配置确认帧(Configure-Ack):所有选项都接受
2、配置否认帧(Configure-Nak):所有选项都理解但不能接受
3、配置拒绝帧(Configgure-Reject):选项有的无法识别或不能接受，需要协商。
```

```
LCP配置选项包括链路上的最长帧长、所使用的鉴别协议(authentication protocol) 的规约(如果有的话)，以及不使用 PPP 帧中的地址和控制字段(因为这两个字段的值是固定的，没有任何信息量，可以在PPP帧的首部中省略这两个字节)。
```

```
协商结束后双方就建立了LCP链路，接着就进入"鉴别"(Authenticate)状态。
在这一状态，值允许传送LCP协议的分组、鉴别协议的分组以及监测链路质量的分组。
若使用口令鉴别协议PAP(password Authentication protocl)，则需要发起通信额一方发送身份标识符和口令。系统可允许用户重试若干次。
如果需要有更好的安全性，则可以使用更加复杂的口令握手鉴别协议CHAP(Challenge-Handshake Authentication Protocol)。
若鉴别身份失败，则转到"链路终止"(Link Terminate)状态。

若鉴别成功，则进入"网络层协议"(Network-Laer Protocol)状态。
```

```
在"网络层协议"状态，PPP链路的两端的网络控制协议NCP根据网络层的不同协议互相交换网络层特定的网络控制分组。
这个步骤是很重要的，因为现在的路由器都能够同时支持多种的网络层协议。
总之，PPP协议两端的网络层可以运行不同的网络层协议，但仍然可使用同一个PPP协议进行通信。
```

```
如果在PPP链路上运行的是IP协议，则对PPP链路的每一端配置IP协议模块(如分配IP地址)时就要使用NCP中支持IP的协议 --- IP 控制协议IPCP(IP Control Protocol)。
IPCP分组也封装成PPP帧(其中的协议字段为0x8021)在PPP链路上传送。
在低速链路上运行时，双方还可以协商使用压缩的TCP和IP首部，以减少在链路上发送的比特数。
```

```
当网络层配置完毕后，链路就进入可进行数据通信的"链路打开"(link open)状态。
链路的两个PPP端点可以彼此向对方发送分组。
两个PPP端点还可以发送回送请求LCP分组(Echo-Request)和回送回答(Echo-Reply)，以检查链路的状态。
```

```
数据传输结束后，可以由链路的一端发出终止请求LCP分组(Terminate-Request)请求终止连接，在收到对方发来的终止确认LCP分组(Terminate-Ack)后，转到"链路终止"状态。
当调制解调器的载波停止后，则回到"链路静止"状态
```

```
图3-12的右方的灰色方框给出了对PPP协议的几个状态的说明。
从设备之间的无链路开始，到建立物理链路，再建立链路控制协议LCP链路。
经过鉴别后再建立网络控制协议NCP，然后才能交换数据。
由此可见，PPP协议已经不是纯粹的数据链路层的洗衣，它还包含了物理层和网络层的内容。
```



##  3、使用广播信道的数据链路层

```
广播信道可以进行一对多的通信。
下面要讨论的局域网使用的就是广播信道。
局域网是在20世纪70年代末发展起来的。
局域网技术在计算机网络中占有非常重要的地位。
```

### 1、局域网的数据链路层

```
局域网最主要的特点是：网络为一个单位所拥有，且地理位置和站点数目均有限。
在局域网刚刚出现时，局域网比广域网具有较高的数据率、较低的时延和较小的误码率。
但随着光纤技术在广域网中普遍使用，现在广域网也具有很高的数据率和很低的误码率。
```

```
局域网具有如下的一些主要优点：
1、具有广播功能，从一个站点可很方便的访问全网。
	局域网上的主机可共享连接在局域网上的各种硬件和软件资源。
	
2、便于系统的扩展和逐渐地演变，各设备可灵活调整和改变。

3、提高了系统的可靠性(reliability)、可用性(availadbility)、和生存性(survivability)。
```

```
局域网可按网络拓扑进行分类。
	图3-13(a)是星形网。
		由于集线器(hub)的出现和双绞线大量用于局域网中，星形以太网以及多级星形结构的以太网获得了非常广泛的应用。
		
	图3-13(b)是环形网
	
	图3-13(c)为总线网，各站直接连在总线上。
	总线两端的匹配电阻吸收在总线上传播的电磁波信号的能量，避免在总线上产生有害的电磁波反射。
```

![](images01-01/01-18.jpg)



```
共享信道要着重考虑的一个问题就是如何使众多用户能够合理而方便得共享通信媒体资源。
这在技术上有两种方法：
```

````
1、静态划分信道，
如在第2章的2.4节中已经介绍过的频分复用、时分复用、波分复用和马分复用等。
用户只要分配到了信道就不会和其他用户发生冲突。
但这种划分信道的方法代价较高，不适合局域网使用。
````

```
2、动态媒体接入控制，它又称为多点接入(multiple access),其特点是信道并非在用户通信时固定分配给用户。
这里又分为以下两类：

随机接入： 随机接入的特点是所有的用户可随机的发送信息。
	但如果恰巧有两个或更多的用户在同一时刻发送信息，那么在共享媒体上就要产生碰撞(即发生了冲突)，使得这些用户的发送都失败。
	因此，必须有解决碰撞的网络协议。
	
受控接入:  受控接入的特点是用户不能随机的发送信息而必须服从一定的控制。	
	这类的典型代表有分散控制的令牌环局域网和集中控制的多点线路探询(polling)，或称为轮询。
```

```
属于随机接入的以太网将被重点讨论。受控接入目前使用的较少。

由于以太网的数据率已演进到了每秒百兆比特、吉比特或甚至10吉比特，因此通常就用"传统以太网"来表示最早流行的10Mb/s速率的以太网。
下面我们先介绍传统以太网。
```

1、介绍

#### 2、适配器的作用

```
首先我们从一般的概念上讨论下计算机是怎样连接到局域网的。
计算机与外界局域网的连接是通过通信适配器(adapter)。
适配器本来是在主机箱内插入的一块网络接口板(或者是在笔记本电脑中插入一块 PCMCIA 卡 --- 个人计算机存储器卡接口适配器)。
这种接口板又称为网络接口卡 NIC (Network Interface Card)或简称为"网卡"。
由于现在计算机主板上已经都嵌入了这种适配器，不再使用单独的网卡了，因此本书使用适配器这个更准确的术语。
在适配器上面装有处理器和存储器(包括RAM和ROM)。
```

```
适配器和局域网之间的通信时通过电缆或双绞线以串行传输方式进行的，而适配器和计算机之间的通信则是通过计算机主板上的I/O总线以并行传输方式进行的。
因此，适配器的一个重要功能就是要进行数据串行传输和并行传输的转换。
由于网络上的数据率和计算机总线上的数据率并不相同，因此在适配器中必须装有对数据进行缓存的存储芯片。
若在主板上插入适配器时，还必须把管理该适配器的设备驱动程序安装在计算机的操作系统中。
这个驱动程序以后就会告诉适配器，应当从存储器的什么位置上把多长的数据块发送到局域网，或者应当在存储器的什么位置上把局域网传送过来的数据块存储下来。
适配器还要能够实现以太网协议。
```

```
请注意，适配器的内容虽然是放在数据链路层中讲授，但适配器所实现的功能却包含了数据链路层及物理层这两层次的功能。
现在的芯片的集成度都很高，以致很难把一个适配器的功能严格按照层次的关系精确的划分开。
```

```
适配器接收和发送各种帧时不使用计算机的CPU。
这时CPU可以处理其他任务。
当适配器收到有差多的帧时，就把这个帧丢弃而不必通知计算机。
当适配器收到正确的帧时，它就是用中断来通知该计算机并交付协议栈中的网络层。
当计算机要发送IP数据报时，就由协议栈把IP数据报向下交给适配器，组装成帧后发送到局域网。

图3-15表示适配器的作用。
我们特别要注意，计算机的硬件地址就在适配器的ROM中，而计算机的软件地址--IP地址，则在计算机的存储器中。
```

![](images01-01/01-19.jpg)



### 2、CSMA/CD协议

```
最早的以太网是将许多计算机都连接到一根总线上。
当初认为这种连接方法既简单又可靠，因为在那个时代普遍的认为："有源器件不可靠，而无源的电缆线才是最可靠的"。
```

````
总线的特点是：当一台计算机发送数据时，总线上的所有计算机都能检测到这个数据。
这种就是广播通信方式。
但我们并不总是要在局域网上进行一对多的广播通信。
为了在总线上实现一对一的通信，可以使每一台计算机的适配器拥有一个与其他适配器都不同的地址。
在发送数据帧时，在帧的首部写明接收站的地址。
现在的电子技术可以很容易做到：仅当数据帧的目的地址与适配器ROM中存放的硬件地址一致时，该适配器才能接收这个数据帧。
适配器对不是发送给自己的数据帧就丢弃。
这样，具有广播特性的总线上就实现了一对一通信。
````

```
人们也常把局域网上的计算机称为"主机"、"工作站"、"站点"或"站"。
为了通信的简便，以太网采取了以下两种措施：
```

第一，采用较为灵活的无连接工作方式，即不必先建立连接就可以直接发送数据。

```
第一，采用较为灵活的无连接工作方式，即不必先建立连接就可以直接发送数据。
适配器对发送的数据帧不进行编号，也不要求对方发回确认。
这样做可以使以太网工作起来非常简单，而局域网信道的质量很好，因通信质量不好产生差错的概率是很小的。
因此，以太网提供的服务是尽最大努力的交付，即不可靠的交付。
当目的站收到有差错的数据帧时(例如，用CRC查出有差错)，就把帧丢弃，其他什么也不做。
对有差错帧是否需要重传则由高层来决定。
例如，如果高层使用TCP协议，那么TCP就会发现丢失了一些数据。
于是经过一定的时间后，TCP就把这些数据重新传递给以太网进行重传。
但以太网并不知道这是重传帧，而是当新的数据帧来发送。
```

```
我们知道，总线上只要有一台计算机在发送数据，总线的传输资源就被占用。
因此，在同一时间只能允许一台计算机发送数据，否则各计算机之间就会互相干扰，使得所发送的数据被破坏。
因此，如何协调总线上各个计算机的工作就是以太网要解决的一个重要问题。以太网采用最简单的随机接入，但有很好的协议用来减少冲突发生的概率。
这好比有一屋子的人在开讨论会，没有会议主持人控制发言。
想发言的随时可发言，那么你就必须等别人讲完了才能发言(否则就干扰了别人的发言)。
但有时碰巧两个人同时发言了，那么一旦发现冲突，大家都必须都立即停止发言，等听到没有人发言了你再发言。
以太网采用的协调方法和上面的办法非常像，它使用的协议是 CSMA/CD，意思是 载波监听多点接入/碰撞检测(Carrier Sense Multiple Access with Collision Detection)。
```

```
第二，以太网发送的数据都使用曼彻斯特(Manchester)编码的信号。
我们在第二章的2.2.2节中已经简单的介绍过曼彻斯特编码了。
我们知道，二进制基带数字信号通常就是高、低电压交替出现的信号。

使用这种信号的最大问题就是当出现一长串的连1或0时，接收端就无法从收到的比特流中提取位同步(即比特同步)信号。

```

![](images01-01/01-20.jpg)

```
如图3-16所示，曼彻斯特编码的编码方法是把每一个码元再分成两个相等的间隔。
码元1是在前一个间隔为低电压而后一个间隔为高电压。
码元0正好相反，从高电压变到低电压(也可采用相反的约定，即1是"前高后底" 而0是"前低后高")。
这样就保证了在每一个码元的正中间出现一次电压的转换，而接收端就利用这种电压的转换很方便的把位同步信号提取出来。
但是曼彻斯特编码的波形图也不能看出其缺点，这就是它所占用的频带宽度币原始的基带信号增加了一倍(因为每秒传送的码元数加倍了)。
```

```
下面介绍 CSMA/CD 协议的要点。

"多点接入"就是说明这是总线型网络，许多计算机以多点接入的方式连接在一根总线上。
协议的实质就是"载波监听"和"碰撞检测"。

"载波监听"就是用电子技术检测总线上有没有其他计算机也在发送。
其实总线上并没有什么"载波"，这里值不过借用一下"载波"这个名词而已。
因载波监听就是检测信道，这是个很很重要的措施。
不管在发送前，还是在发送中，每个站都必须不停的检测信道。
```

```
在发送前检测信道，是为了获得发送权。
如果检测出已经有其他站在发送，则自己就暂时不许发送数据，必须等到信道变为空闲时才能发送数据。
在发送中检测信道，是为了及时发现有没有其他站的发送和本站发送的碰撞。
这就称为碰撞检测。
```

```
"碰撞检测"也就是"边发送边监听"，即适配器边发送数据边检测信道上的信号电压的变化情况。
以便判断自己在发送数据时其他站是否也在发送数据。
当几个站同时在总线上发送数据时，总线上的信号电压变化幅度将会增大(互相叠加)。
当适配器检测到的信号电压表变化超过一定的门限值时，就认为总线上至少有两个站同时在发送数据，表明产生了碰撞。

所谓"碰撞"就是发生了冲突。
因此"碰撞检测"也被称为"冲突检测"。
这时，总线上传输的信号产生了严重的失真，无法从中恢复出有用的信息来。
因此，任何一个正在发送数据的站，一旦发现总线上出现了碰撞，其适配器就要立即停止发送，免得继续进行无效的发送，白白浪费网络资源，然后等待一段随机事件后再次发送。
```

```
既然每一个站在发送数据之前已经监听到信道为"空闲"，那么为什么还会出现数据在总线上的碰撞呢？
这是因为电磁波在总线上总是以有限的速率传播的。
这和我们开讨论会时相似。
一听见会场安静，我们就立即发言，但偶尔也会发生几个人同时抢着发言而产生冲突的情况。
```

![](images01-01/01-21.jpg)

```
τ δ
图3-17所示的例子可以说明这种情况。
设图中的局域网两端的站A和B相距1km，用同轴电缆相连。
电磁波在1km电缆的传播时延约为 5us(微妙 这个数字应当记住)

因此，A向B发出的数据，在约5us后才能传送到B。换言之，B若在A发送的数据到达B之前发送自己的帧(因为这时B的载波监听检测不到A所发送的信息)，则必然要在某个时间和A发送的帧发生碰撞。
碰撞的结果是两个帧都变得无用。
在局域网的分析中，常把总线上的单程端到端传播时延记为 τ。
发送数据的站希望尽早知道是否发生了碰撞。
那么，A发送数据后，最迟要经过多长时间才能知道自己发送的数据和其他站发送的数据有没有发生碰撞？
从图3-17不难看出，这个时间最多是两倍的总线端到端的传播时延(2τ)，或总线端到端往返传播时延 round -triptime.
由于局域网上任意两个站之间的传播时延有长有短，因此局域网必须按最坏情况设计，即取总线两端的两个站之间的传播时延(这两个站之间的距离最大)为端到端传播时延。
```

```
显然，在使用CSMA/CD协议时，一个站不可能同时进行发送和接收(但必须边发送边监听信道)。
因此使用CSMA/CD 协议的以太网不可能进行全双工通信而只能进行双相交替通信(半双工通信)。
```

```
下面是图3-17中的一些重要的时刻。
在t=0时，A发送数据。B检测到信道为空闲。
在t=τ-δ时(这里 τ>δ>0)，A发送的数据还没有到达B时，由于B检测到信道是空闲，因此B发送数据。

经过时间δ/2后，即在 t=τ-δ/2时，A发送的数据和B发送的数据发生了碰撞。
但这时A和B都不知道发生了碰撞。
在t=τ时，B检测到了发生了碰撞，于是停止了发送数据。
在t=2τ-δ 时，A也检测到了发生了碰撞，因而也停止发送数据。
A和B发送数据均失败，它们都要推迟一段时间再重新发送。
```

```
由此可见，每一个站在自己发送数据之后的一小段时间内，存在着遭遇碰撞的可能性。
这一小段时间是不确定的，它取决于另一个发送数据的站到本站的距离。
因此，以太网不能保证某一时间之内一定能够把自己的数据帧成功的发送出去(因为存在产生碰撞的可能)。
以太网的这一特点称为发送的不确定性。
如果希望以太网上发生碰撞的机会很小，必须使整个以太网的平均通信量远小于以太网的最高数据率。
```

```
从图3-17可看出，最先发送数据帧的A站，在发送数据帧后至多经过时间2τ就可知道所发送的数据帧是否遭受了碰撞。
这就是δ->0的情况。
因此以太网的端到端往返时间2τ称为争用期(contention period)，它是一个很重要的参数。
争用期又称为碰撞窗口(collision period)。
这是因为一个站在发送完数据后，只有通过争用期的"考验"，即经过争用期这段时间还没有检测到碰撞，才能肯定这次发送不会发送碰撞。
这时，就可以放心把这一帧数据顺利发送完毕。
```

```
以太网使用截断二进制指数退避(truncated binary exponential backoff)算法来确定碰撞后重传的时机。
截断二进制指数退避算法并不复杂。
这种算法让发生碰撞的站在停止发送数据后，不是等待信道变为空闲后就立即发送数据，而是推迟(这叫作退避)一个随机的时间。
这点很容易理解，因为如果几个发生碰撞的站都在监听信道，那么都会同时发现信道变成了空闲。
如果大家都同时重新发送，那么肯定又会发生碰撞。
为了使各站进行重传时再次发生冲突的概率减小。
具体的退避算法如下：
```

```
***下面的规定都是针对于 10Mb/s的以太网;如果是 100Mb/s的以太网，其 争用期 和 最短帧长都要更改;


1、协议规定了基本退避时间为争用期2τ，具体的争用期时间是 51.2us.
对于10Mb/s以太网，在争用期内可发送512bit，即64字节。
也可以说争用期是512比特时间。
1比特时间就是发送1比特所需的时间。
所以这种时间单位与数据率密切相关。

2、从离散的整数集合[0,1,...,((2^k) - 1)]中随机取出一个数，记为 r 。重传应推后的时间就是 r 倍的争用期。
上面的参数k按照下面的公式(3-1)计算:

k = Min[重传次数,10]    (3-1)

可见当重传次数不超过10时，参数k等于重传次数;但当重传次数超过10时，k就不再增大而一直等于10.

3、当重传达 16 次仍不能成功时(这表明同时打算发送数据的站太多，以致连续发生冲突)，则丢弃该帧，并向高层报告。
```

```
例如，在第一次重传时，k=1,随机数r从整数{0,1}中选一个数。
因此重传的站可选择的重传推迟时间是 0 或 2τ，在这两个时间中随机选择一个。

若再发生碰撞，则在第2次重传时，k=2，随机数r就从整数{0,1,2,3}中选一个数。
因此重传推迟的时间是在 0,2τ,4τ,6τ,这4个时间中选随机的选取一个; 

（为什么是 0,2τ,4τ,6τ, 而不是 0,1τ,2τ,3τ 呢;因为 重传应推后的时间就是 r 倍的争用期。0争用期,1争用期,2争用期,3争用期 这个争用期是 2τ; 所以就是 0*2τ 1*2τ 2*2τ 3*2τ。
就是  0,2τ,4τ,6τ）

同样，若再发生碰撞，则重传时k=3,随机数r就从整数{0,1,2,3,4,5,6,7}中选一个数。
依此类推。
若连续多次发生冲突，就表明可能有较多的站参与争用信道。
但使用上述退避算法可使重传需要推迟的平均时间随重传次数而增大(这也是动态退避)，因而减小发生碰撞的概率，有利于整个系统的稳定。
```

```
我们还应注意到，适配器每发送一个新的帧，就要执行一次 CSMA/CD算法。
适配器对过去发生过的碰撞并无记忆功能。
因此，当好几个适配器正在执行指数退避算法时，很可能有某一个适配器发送的新帧能够碰巧立即成功地插入到信道中，得到了发送权，而已经推迟好几次发送的站，有可能很不巧，还要继续执行退避算法，继续等待。
```

```
自己的解释：
我们将争用期转换成 帧长来检测是否冲突;这样只要规定最短帧长就好了;并不需要定时争用期;
比如如果51.2us是争用期;那么10Mb/s在51.2us里面一共可以发送64字节的数据;只要在发送前64字节内没有收到数据,那么就说明没有冲突;一旦发送超过了64字节;整个总线里面都是发送方发送的字节;其他适配器就可以直接检测到数据;
这样的话就把争用期转换为了最短帧长;

同样的这样对接收端也适用;接收端也不需要在接收到一个帧以后开定时器监听争用期内是否收到其他数据;
只需要检测收到的数据是否超过64字节;
如果超过了64字节,说明发送端并没有收到冲突数据,安心接收就好;
如果没有超过64字节，说明发送端收到冲突数据，直接丢弃该帧就好;


冲突检测：边发送边对介质上电压信号进行检测，当电压摆动值超过一定门限时就认为发生了冲突。一旦发生冲突就停止发送数据，然后根据协议进行重传。
```

```
现在考虑一种情况。
某个站发送了一个很短的帧，但发送了碰撞。
不过在这个帧发送完毕后发送站才检测到发生了碰撞。
已经没有办法中止帧的发送，因为这个帧早已发送完了。
这样，在发送完毕之前没有检测出碰撞，这显然是我们所不希望的。
为了避免发生这种情况，以太网规定了一个最短帧长64字节，即512bit。
如果要发送的数据非常少，那么必须加入一些填充字节，使帧长不小于64字节。
对于10Mb/s以太网，发送512bit的时间需要51.2us,也就是上面提到的争用期。
```

```
由此可见，以太网在发送数据时，如果在争用期(共发生了64字节)没有发生碰撞，那么后续发送的数据就一定不会发生冲突。
换句话说，如果发生碰撞，就一定是在发送的前64字节之内。
由于一检测到冲突就立即中止发送，这时已经发送出去的数据一定小于64字节，因此凡长度小于64字节的帧都是由于冲突而异常中止的无效帧。
只要收到了这种无效帧，就应当立即将其丢弃。
```

```
前面已经讲过，信号在以太网上传播 1km 大约需要 5微妙。
以太网上最大的端到端时延必须小于争用期的一半(即25.6us)，这相当于以太网的最大端到端长度约为5km。
实际上的以太网覆盖范围远远没有这样大。
因此，实用的以太网都能在争用期51.2us内检测到可能发生的碰撞。
以太网的争用期确定为51.2us,不仅考虑到以太网的端到端时延，而且还包括其他因素，如存在的转发器所增加的时延，以及下面要讲到的强化碰撞的干扰信号的持续时间。
```

```
下面介绍强化碰撞的概念。
这就是当发送数据的站一旦发现发生了碰撞，除了立即停止发送数据外，还要再继续发送32比特或48比特的人为干扰信号(jamming signal)，以便让所用用户都知道现在已经发生了碰撞(图3-18)。
对于10Mb/s以太网，发送32(或48)比特只需要3.2(或4.8)us.
```

![](images01-01/01-22.jpg)

![](images01-01/01-23.jpg)

![](images01-01/01-24.jpg)



## 4、使用广播信道的数据链路层

### 1、使用集线器的星形拓扑

```
传统以太网最初是使用粗同轴电缆，后来演进到使用比较便宜的细同轴电缆，最后发展为使用更便宜和更灵活的双绞线。
这种以太网采用星形拓扑，在星形的中心则增加了一种可靠性非常高的设备，叫做集线器(hub),如图3-19所示。
双绞线以太网总是和集线器配合使用的。
每个站需要用两对无屏蔽双绞线(放在一根电缆内)，分别用于发送和接收。
双绞线的两端使用RJ-45插头。
由于集线器使用了大规模集成电路芯片，因此集线器的可靠性就大大提高了。
1990年IEEE制定出星形以太网10BASE-T的标准802.3i。
"10"代表10Mb/s的数据率，BASE表示连接线上的信号是基带信号，T代表双绞线。
实践证明，这比使用具有大量机械接头的无缘电缆要可靠的多。
由于使用双绞线电缆的以太网价格便宜和使用方便，因此粗缆和细缆以太网现在都已成为历史，并已从市场上消失了。
```

![](images01-01/01-25.jpg)

```
但10BAST-T以太网的通信距离稍短，每个站到集线器的距离不超过100m。
这种性价比很高的10BASE-T双绞线以太网的出现，是局域网发展史上的一个非常重要的里程碑，它为以太网在局域网中的统治地位奠定了牢固的基础。
使双绞线能够传送高速数据的主要措施是把双绞线的绞合度做的非常精确。
这样不仅可使特性阻抗均匀以减少失真，而且大大减少了电磁波辐射和无线电频率的干扰。
在多对双绞线的电缆中，还要使用更加复杂的绞合方法。
```

```
集线器的一些特点如下：
1、从表面上看，使用集线器的局域网在物理上是一个星型网，但由于集线器是使用电子器件来模拟实际电缆的工作，因此整个系统仍像一个传统以太网那样运行。
也就是说，使用集线器的以太网在逻辑上仍是一个总线网，各站共享逻辑上的总线，使用的还是CSMA/CD协议(更具体些说，是各站中的适配器执行CSMA/CD协议)。
网络中的各站必须竞争对传输媒体的控制，并且在同一时刻至多只允许一个站发送数据。
因此这种10BASE-T以太网又称为星型总线(star-shaped bus)或盒中总线(bus in a box)。
```









































